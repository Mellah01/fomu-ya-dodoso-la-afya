<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dodoso la Afya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .page-container {
            display: none;
        }
        .page-container.active {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 24px;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            max-width: 400px;
            text-align: center;
        }
        #admin-login-area {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

<div id="app-container" class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl">

    <div id="login-page" class="page-container active p-8">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Mfumo wa Dodoso la Afya</h1>
                <div class="space-y-4">
                    <button id="fill-form-link" class="w-full bg-indigo-600 text-white font-bold px-8 py-3 rounded-full shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                        WEWE NI MGONJWA? JAZA FOMU SASA.
                    </button>
                    <button id="toggle-admin-login" class="w-full bg-gray-200 text-gray-700 font-bold px-8 py-3 rounded-full shadow-lg hover:bg-gray-300 transition-colors duration-300">
                        INGIA KAMA MSIMAMIZI
                    </button>
                </div>
                <div id="admin-login-area" class="mt-8">
                    <p class="text-gray-500 mb-4">Tafadhali ingiza nenosiri ili kufikia dashibodi.</p>
                    <input type="password" id="admin-password" placeholder="Nenosiri" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
                    <button id="login-btn" class="w-full bg-green-600 text-white font-bold px-8 py-3 rounded-full shadow-lg hover:bg-green-700 transition-colors duration-300">Ingia</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="form-page" class="page-container p-8">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-3xl font-bold text-gray-800">Dodoso la Afya ya Mgonjwa (PHQ-9)</h1>
            <button id="back-to-login" class="bg-gray-200 text-gray-700 font-semibold px-4 py-2 rounded-full hover:bg-gray-300 transition-colors duration-300">Rudi Mwanzo</button>
        </div>
        <div class="mb-6">
            <p class="text-sm text-gray-600 font-medium">Ufunguo wa Alama: <span class="font-bold text-indigo-700">0=hamna kabisa, 1= siku kadhaa, 2= zaidi ya siku kadhaa, 3= karibia kila siku.</span></p>
        </div>
        <p class="text-gray-500 mb-8">Tafadhali jibu maswali yote kwa uaminifu. Matokeo yako yataonyeshwa kabla ya kutuma.</p>
        <form id="phq-form">
            <div id="questions-container" class="space-y-6"></div>
            <div class="bg-white p-6 rounded-lg shadow-md mt-10">
                <p class="text-lg font-semibold text-gray-700 mb-4">Ni kwa jinsi gani matatizo haya yamekufanya ushindwe kufanya kazi zako, kushughulika na vitu vya nyumbani, au kuwa na mahusiano mazuri na watu wengine?</p>
                <div class="flex flex-wrap gap-6 text-base">
                    <label class="inline-flex items-center cursor-pointer p-3 rounded-lg hover:bg-indigo-50 transition-colors duration-200">
                        <input type="radio" name="difficulty" value="Sio ngumu kabisa" class="form-radio text-indigo-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Sio ngumu kabisa</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer p-3 rounded-lg hover:bg-indigo-50 transition-colors duration-200">
                        <input type="radio" name="difficulty" value="Ngumu kiasi" class="form-radio text-indigo-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Ngumu kiasi</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer p-3 rounded-lg hover:bg-indigo-50 transition-colors duration-200">
                        <input type="radio" name="difficulty" value="Ngumu sana" class="form-radio text-indigo-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Ngumu sana</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer p-3 rounded-lg hover:bg-indigo-50 transition-colors duration-200">
                        <input type="radio" name="difficulty" value="Ngumu mno" class="form-radio text-indigo-600 h-5 w-5">
                        <span class="ml-2 text-gray-700">Ngumu mno</span>
                    </label>
                </div>
            </div>
            <div id="preview" class="hidden mt-8 p-6 rounded-lg shadow-inner bg-indigo-50 border-l-4 border-indigo-500">
                <h3 class="text-xl font-bold text-indigo-800 mb-2">Muhtasari wa Matokeo Yako</h3>
                <p id="preview-score" class="text-lg font-semibold text-gray-700"></p>
                <p id="preview-interpretation" class="text-lg font-semibold text-gray-700"></p>
                <p id="preview-difficulty" class="text-lg font-semibold text-gray-700"></p>
            </div>
            <div class="flex justify-center mt-8 gap-4">
                <button type="button" id="preview-btn" class="bg-indigo-600 text-white font-bold px-8 py-3 rounded-full shadow-lg hover:bg-indigo-700 transition-colors duration-300">Onyesha Matokeo</button>
                <button type="submit" id="submit-btn" class="bg-green-600 text-white font-bold px-8 py-3 rounded-full shadow-lg hover:bg-green-700 transition-colors duration-300 hidden">Tuma Majibu Yako</button>
            </div>
        </form>
    </div>
    
    <div id="admin-dashboard-page" class="page-container p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Dashibodi ya Majibu</h1>
            <button id="logout-btn" class="bg-red-500 text-white font-bold px-4 py-2 rounded-full shadow-md hover:bg-red-600 transition-colors duration-300">Ondoka</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-blue-50 p-6 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-blue-700">Jumla ya Majibu</p>
                <p id="total-clients" class="text-4xl font-bold text-blue-900 mt-2">0</p>
            </div>
            <div class="bg-green-50 p-6 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-green-700">Wastani wa Alama</p>
                <p id="average-score" class="text-4xl font-bold text-green-900 mt-2">0</p>
            </div>
            <div class="bg-red-50 p-6 rounded-lg shadow-md">
                <p class="text-sm font-semibold text-red-700">Wateja Wenye Sonona Kali</p>
                <p id="high-risk-count" class="text-4xl font-bold text-red-900 mt-2">0</p>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Uchambuzi wa Athari</h2>
            <div class="flex flex-col md:flex-row items-center justify-center gap-8">
                <div class="w-full max-w-sm md:w-1/2">
                    <canvas id="impact-chart"></canvas>
                </div>
                <div class="w-full md:w-1/2">
                    <p class="text-lg text-gray-700 mb-2">Asilimia ya wagonjwa walioathirika sana (Sonona Kali au Kali Sana).</p>
                    <p id="chart-summary" class="text-2xl font-bold text-gray-800"></p>
                </div>
            </div>
        </div>

        <div class="flex justify-end mb-4 gap-4">
            <button id="download-json-btn" class="bg-gray-600 text-white font-bold px-4 py-2 rounded-full shadow-md hover:bg-gray-700 transition-colors duration-300">Pakua JSON</button>
            <button id="download-csv-btn" class="bg-gray-600 text-white font-bold px-4 py-2 rounded-full shadow-md hover:bg-gray-700 transition-colors duration-300">Pakua CSV</button>
        </div>
        <div class="overflow-x-auto rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">MATOKEO YA WAGONJWA</h2>
            <table class="min-w-full bg-white">
                <thead class="bg-gray-200">
                    <tr class="text-left text-gray-600 uppercase text-sm">
                        <th class="py-3 px-6 border-b border-gray-300">Tarehe</th>
                        <th class="py-3 px-6 border-b border-gray-300">Q1-Q9</th>
                        <th class="py-3 px-6 border-b border-gray-300">Ugumu</th>
                        <th class="py-3 px-6 border-b border-gray-300">Alama</th>
                        <th class="py-3 px-6 border-b border-gray-300">Tafsiri</th>
                    </tr>
                </thead>
                <tbody id="responses" class="text-gray-700 text-sm"></tbody>
            </table>
        </div>
    </div>
    
    <div id="patient-logout-page" class="page-container p-8">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md text-center">
                <h1 class="text-3xl font-bold text-green-600 mb-4">Majibu Yamepokelewa!</h1>
                <p class="text-gray-500 mb-6">Asante kwa kujaza fomu. Huduma ya afya inapatikana kwako.</p>
                <button id="patient-return-btn" class="w-full bg-indigo-600 text-white font-bold px-8 py-3 rounded-full shadow-lg hover:bg-indigo-700 transition-colors duration-300">Rudi Mwanzo</button>
            </div>
        </div>
    </div>
</div>

<div id="message-modal" class="modal">
    <div class="modal-content">
        <span id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 cursor-pointer text-xl font-bold">&times;</span>
        <p id="modal-text" class="text-lg font-semibold text-gray-700 mb-4"></p>
        <button id="ok-btn" class="bg-indigo-600 text-white font-bold px-6 py-2 rounded-full shadow-md hover:bg-indigo-700 transition-colors duration-300">Sawa</button>
    </div>
</div>

<script>
    const adminPassword = "password123";
    const localStorageKey = "patientResponses";

    // Vipengele
    const loginPage = document.getElementById("login-page");
    const formPage = document.getElementById("form-page");
    const adminDashboardPage = document.getElementById("admin-dashboard-page");
    const patientLogoutPage = document.getElementById("patient-logout-page");
    const messageModal = document.getElementById("message-modal");
    const modalText = document.getElementById("modal-text");
    const okBtn = document.getElementById("ok-btn");
    const closeModalBtn = document.getElementById("close-modal-btn");
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const toggleAdminLogin = document.getElementById("toggle-admin-login");
    const adminLoginArea = document.getElementById("admin-login-area");
    const fillFormLink = document.getElementById("fill-form-link");
    const backToLoginBtn = document.getElementById("back-to-login");
    const patientReturnBtn = document.getElementById("patient-return-btn");
    const phqForm = document.getElementById("phq-form");
    const responsesTbody = document.getElementById("responses");
    const adminPasswordInput = document.getElementById("admin-password");
    const downloadJsonBtn = document.getElementById("download-json-btn");
    const downloadCsvBtn = document.getElementById("download-csv-btn");
    const impactChartCtx = document.getElementById('impact-chart').getContext('2d');
    let impactChart;

    // Onyesha ukurasa maalum
    function showPage(page) {
        document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
        page.classList.add('active');
    }

    // Onyesha ujumbe wa modal
    function showMessage(text, callback) {
        modalText.textContent = text;
        messageModal.style.display = 'flex';
        okBtn.onclick = () => {
            closeModal();
            if (callback) callback();
        };
    }

    // Funga modal
    function closeModal() {
        messageModal.style.display = 'none';
    }

    // Matukio ya modal
    closeModalBtn.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => {
        if (e.target === messageModal) {
            closeModal();
        }
    });

    // Mantiki ya kufichua eneo la kuingia kwa msimamizi
    toggleAdminLogin.addEventListener('click', () => {
        adminLoginArea.style.display = adminLoginArea.style.display === 'block' ? 'none' : 'block';
    });

    // Mantiki ya kuelekeza kwenye fomu
    fillFormLink.addEventListener('click', () => {
        showPage(formPage);
    });
    
    // Mantiki ya kurudi kwenye ukurasa wa kuingia kutoka fomu
    backToLoginBtn.addEventListener('click', () => {
        showPage(loginPage);
    });

    // Mantiki ya Kuingia
    loginBtn.addEventListener('click', () => {
        if (adminPasswordInput.value === adminPassword) {
            showPage(adminDashboardPage);
            loadResponses();
        } else {
            showMessage("Nenosiri si sahihi.");
        }
    });

    // Mantiki ya Kuondoka
    logoutBtn.addEventListener('click', () => {
        adminPasswordInput.value = "";
        adminLoginArea.style.display = 'none';
        showPage(loginPage);
    });

    // Mantiki ya Kurudi kwenye Fomu
    patientReturnBtn.addEventListener('click', () => {
        showPage(loginPage);
    });

    // Maswali
    const questions = [
        'Kufanya vitu kidogo au kutokuwa na hamu ya kufanya vitu?',
        'Kujisikia mnyonge, kuwa na sonona au kukata tamaa?',
        'Shida kupata usingizi, kulala au kulala sana?',
        'Kuchoka au kuwa na nguvu kidogo?',
        'Kukosa hamu ya kula au kula sana?',
        'Kujisikia vibaya kuhusu wewe mwenyewe, au umeshindwa?',
        'Unapata shida kuwa makini kwenye vitu kama kusoma magazeti?',
        'Kutembea au kuzungumza taratibu sana kiasi watu wengine wamegundua?',
        'Mawazo ya kuwa bora ufe au kujiumiza kwa namna yeyote?'
    ];

    // Tengeneza maswali
    const container = document.getElementById("questions-container");
    questions.forEach((q, i) => {
        const div = document.createElement("div");
        div.className = "bg-white p-6 rounded-lg shadow-md";
        div.innerHTML = `
            <p class="font-medium text-lg text-gray-800">${i + 1}. ${q}</p>
            <div class="flex flex-wrap gap-4 mt-4">
                <label class="inline-flex items-center cursor-pointer p-3 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <input type="radio" name="q${i + 1}" value="0" class="form-radio h-5 w-5 text-indigo-600">
                    <span class="ml-2 text-gray-700">Hamna kabisa (0)</span>
                </label>
                <label class="inline-flex items-center cursor-pointer p-3 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <input type="radio" name="q${i + 1}" value="1" class="form-radio h-5 w-5 text-indigo-600">
                    <span class="ml-2 text-gray-700">Siku kadhaa (1)</span>
                </label>
                <label class="inline-flex items-center cursor-pointer p-3 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <input type="radio" name="q${i + 1}" value="2" class="form-radio h-5 w-5 text-indigo-600">
                    <span class="ml-2 text-gray-700">Zaidi ya siku kadhaa (2)</span>
                </label>
                <label class="inline-flex items-center cursor-pointer p-3 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <input type="radio" name="q${i + 1}" value="3" class="form-radio h-5 w-5 text-indigo-600">
                    <span class="ml-2 text-gray-700">Karibia kila siku (3)</span>
                </label>
            </div>
        `;
        container.appendChild(div);
    });

    // Kitufe cha kuonyesha matokeo
    document.getElementById("preview-btn").addEventListener("click", () => {
        let total = 0, all = true;
        const answers = {};
        questions.forEach((q, i) => {
            const sel = document.querySelector(`input[name="q${i + 1}"]:checked`);
            if (sel) {
                total += +sel.value;
                answers[`q${i + 1}`] = +sel.value;
            } else {
                all = false;
            }
        });
        const diff = document.querySelector('input[name="difficulty"]:checked');
        answers["difficulty"] = diff ? diff.value : "";
        if (!all || !diff) {
            showMessage("Tafadhali jaza maswali yote kwanza.");
            return;
        }
        let tafsiri = "";
        if (total <= 4) tafsiri = "Hakuna/Sonona ya kawaida";
        else if (total <= 9) tafsiri = "Sonona ya kiwango cha chini";
        else if (total <= 14) tafsiri = "Sonona ya kiwango cha wastani";
        else if (total <= 19) tafsiri = "Sonona kali";
        else tafsiri = "Sonona kali sana";
        answers["score"] = total;
        answers["interpretation"] = tafsiri;
        document.getElementById("preview-score").textContent = `Jumla ya Alama: ${total}`;
        document.getElementById("preview-interpretation").textContent = `Tafsiri: ${tafsiri}`;
        document.getElementById("preview-difficulty").textContent = `Ugumu: ${answers["difficulty"]}`;
        document.getElementById("preview").classList.remove("hidden");
        document.getElementById("submit-btn").classList.remove("hidden");
        window.previewData = answers;
    });

    // Tuma majibu
    phqForm.addEventListener("submit", (e) => {
        e.preventDefault();
        if (!window.previewData) {
            showMessage("Tafadhali bofya 'Onyesha Matokeo' kwanza.");
            return;
        }
        let responses = JSON.parse(localStorage.getItem(localStorageKey)) || [];
        const newResponse = {
            timestamp: new Date().toLocaleString(),
            ...window.previewData
        };
        responses.push(newResponse);
        localStorage.setItem(localStorageKey, JSON.stringify(responses));
        showMessage("Majibu yako yamepokelewa.", () => {
            showPage(patientLogoutPage);
        });
        phqForm.reset();
        document.getElementById("preview").classList.add("hidden");
        document.getElementById("submit-btn").classList.add("hidden");
        if (adminDashboardPage.classList.contains('active')) {
            loadResponses();
        }
    });

    // Pata majibu (Dashibodi ya Msimamizi)
    function loadResponses() {
        responsesTbody.innerHTML = "";
        const responses = JSON.parse(localStorage.getItem(localStorageKey)) || [];
        let totalScore = 0;
        let highRiskCount = 0;
        if (responses.length > 0) {
            responses.forEach(r => {
                const score = r.score;
                totalScore += score;
                if (score >= 15) {
                    highRiskCount++;
                }
                const tr = document.createElement("tr");
                tr.className = "hover:bg-gray-50 transition-colors duration-200";
                tr.innerHTML = `
                    <td class="py-3 px-6 border-b">${r.timestamp}</td>
                    <td class="py-3 px-6 border-b text-center">${questions.map((q, i) => r[`q${i+1}`]).join(', ')}</td>
                    <td class="py-3 px-6 border-b">${r.difficulty}</td>
                    <td class="py-3 px-6 border-b font-semibold text-lg">${r.score}</td>
                    <td class="py-3 px-6 border-b">${r.interpretation}</td>
                `;
                responsesTbody.appendChild(tr);
            });
        } else {
            responsesTbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Hakuna data iliyopatikana.</td></tr>`;
        }
        document.getElementById("total-clients").textContent = responses.length;
        document.getElementById("average-score").textContent = responses.length > 0 ? (totalScore / responses.length).toFixed(1) : "0";
        document.getElementById("high-risk-count").textContent = highRiskCount;
        
        // Sasisha chati
        updateChart(responses.length, highRiskCount);
    }
    
    // Sasisha chati
    function updateChart(totalResponses, highRiskCount) {
        const lowRiskCount = totalResponses - highRiskCount;
        const highRiskPercentage = totalResponses > 0 ? ((highRiskCount / totalResponses) * 100).toFixed(1) : 0;
        const lowRiskPercentage = totalResponses > 0 ? ((lowRiskCount / totalResponses) * 100).toFixed(1) : 0;

        document.getElementById("chart-summary").textContent = `${highRiskPercentage}%`;

        if (impactChart) {
            impactChart.destroy();
        }

        impactChart = new Chart(impactChartCtx, {
            type: 'pie',
            data: {
                labels: ['Sonona Kali (alama ≥ 15)', 'Wengine'],
                datasets: [{
                    label: 'Athari kwa Wagonjwa',
                    data: [highRiskCount, lowRiskCount],
                    backgroundColor: [
                        '#ef4444', // Red
                        '#22c55e'  // Green
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.parsed;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    label += `${value} (${percentage}%)`;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // Pakua data kama JSON
    downloadJsonBtn.addEventListener("click", () => {
        const responses = JSON.parse(localStorage.getItem(localStorageKey)) || [];
        const dataStr = JSON.stringify(responses, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "matokeo_ya_wagonjwa.json";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    // Pakua data kama CSV
    downloadCsvBtn.addEventListener("click", () => {
        const responses = JSON.parse(localStorage.getItem(localStorageKey)) || [];
        if (responses.length === 0) {
            showMessage("Hakuna data ya kupakua.");
            return;
        }
        const headers = ["Tarehe", ...questions.map((q, i) => `Q${i+1}`), "Ugumu", "Alama", "Tafsiri"];
        let csvContent = headers.join(",") + "\n";
        responses.forEach(r => {
            const row = [
                `"${r.timestamp}"`,
                ...questions.map((q, i) => r[`q${i+1}`]),
                `"${r.difficulty}"`,
                r.score,
                `"${r.interpretation}"`
            ].join(",");
            csvContent += row + "\n";
        });
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "matokeo_ya_wagonjwa.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

</script>
</body>
</html>